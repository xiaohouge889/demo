# 代理连接错误解决方案

## 问题现象

错误信息：
```
[vite] http proxy error: /api/settings
AggregateError [ECONNREFUSED]:
    at internalConnectMultiple (node:net:1134:18)
    at afterConnectMultiple (node:net:1715:7)
```

## 问题原因

**前端无法连接到后端服务器**（端口 3000），可能的原因：
1. **后端服务器没有运行**（最常见）
2. 后端服务器启动失败
3. 后端服务器崩溃
4. 后端服务器在不同的端口运行

## 解决方案

### 方案1：启动后端服务器（推荐）

**问题分析**：
- 前端（Vite）运行在端口 5173
- 后端（Express）应该运行在端口 3000
- 错误 `ECONNREFUSED` 表示无法连接到端口 3000
- **说明后端服务器没有运行**

**解决方法**：

1. **检查后端是否在运行**：
   ```bash
   netstat -ano | findstr :3000
   ```
   如果没有输出，说明后端没有运行

2. **启动后端服务器**：
   
   **方法A：同时启动前后端（推荐）**：
   ```bash
   npm run dev
   ```
   这会同时启动前端（端口 5173）和后端（端口 3000）

   **方法B：分别启动**：
   ```bash
   # 终端1：启动后端
   cd backend
   npm run dev
   
   # 终端2：启动前端
   cd frontend
   npm run dev
   ```

3. **验证后端是否启动**：
   - 查看终端输出，应该看到：
     ```
     服务器运行在 http://localhost:3000
     API健康检查: http://localhost:3000/api/health
     ```
   - 或者在浏览器访问：http://localhost:3000/api/health
   - 应该看到 JSON 响应

4. **刷新前端页面**：
   - 前端会自动连接到后端
   - 代理错误应该消失

### 方案2：检查后端启动错误

如果后端无法启动，检查终端错误信息：

**常见错误**：
1. **端口占用**：
   - 错误：`EADDRINUSE: address already in use :::3000`
   - 解决：关闭占用端口的进程（见"端口占用问题解决方案.md"）

2. **依赖未安装**：
   - 错误：`Cannot find module 'xxx'`
   - 解决：运行 `cd backend && npm install`

3. **配置文件错误**：
   - 检查 `.env` 文件格式是否正确
   - 检查 `config.js` 是否有语法错误

### 方案3：检查后端端口

如果后端在不同的端口运行：

1. **检查后端实际运行的端口**：
   - 查看后端启动日志
   - 或检查 `backend/.env` 中的 `PORT` 配置

2. **修改前端代理配置**（如果需要）：
   编辑 `frontend/vite.config.js`：
   ```javascript
   proxy: {
     '/api': {
       target: 'http://localhost:实际端口',  // 改为实际端口
       changeOrigin: true
     }
   }
   ```

3. **重启前端服务器**

## 快速诊断步骤

1. **检查后端是否运行**：
   ```bash
   netstat -ano | findstr :3000
   ```

2. **如果没有运行，启动后端**：
   ```bash
   npm run dev
   ```
   或
   ```bash
   cd backend && npm run dev
   ```

3. **检查后端启动日志**：
   - 应该看到 "服务器运行在 http://localhost:3000"
   - 如果有错误，根据错误信息解决

4. **测试后端连接**：
   - 浏览器访问：http://localhost:3000/api/health
   - 应该看到 JSON 响应

5. **刷新前端页面**：
   - 代理错误应该消失

## 常见问题

### Q: 为什么会出现代理错误？

A: 因为前端（Vite）配置了代理，将 `/api` 请求转发到后端（端口 3000）。如果后端没有运行，就会出现连接被拒绝的错误。

### Q: 前端能启动，但后端不能启动？

A: 检查后端启动错误：
1. 查看终端错误信息
2. 检查端口是否被占用
3. 检查依赖是否安装
4. 检查配置文件是否正确

### Q: 如何确保前后端都启动？

A: 使用 `npm run dev`（在项目根目录），这会同时启动前后端。

### Q: 可以只运行前端吗？

A: 可以，但 API 请求会失败（因为后端没有运行）。前端界面可以显示，但功能会报错。

### Q: 后端启动成功，但前端还是报错？

A: 
1. 检查后端是否真的在运行（访问 http://localhost:3000/api/health）
2. 检查前端代理配置是否正确（`frontend/vite.config.js`）
3. 刷新前端页面
4. 检查浏览器控制台是否有其他错误

## 验证步骤

1. **后端启动成功标志**：
   ```
   服务器运行在 http://localhost:3000
   API健康检查: http://localhost:3000/api/health
   ```

2. **测试后端连接**：
   浏览器访问：http://localhost:3000/api/health
   应该看到：`{"status":"ok","message":"服务运行正常",...}`

3. **前端连接正常**：
   - 刷新前端页面
   - 不再出现代理错误
   - 功能正常使用
