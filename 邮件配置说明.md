# 邮件配置说明

## 概述

本系统使用 Nodemailer 发送邮件。需要配置 SMTP 服务器信息才能使用邮件功能。

## 重要提示

**⚠️ 网络访问问题**：
- 如果在中国大陆使用，**强烈推荐使用 QQ 邮箱或 163 邮箱**，因为 Gmail/Outlook 可能无法直接访问
- Gmail 连接超时（ETIMEOUT/EDNS）是正常的网络问题，不是配置错误

## 配置步骤

### 1. 创建环境变量配置文件

在 `backend` 目录下创建 `.env` 文件（如果不存在），添加邮件配置：

```env
# 邮件服务配置
EMAIL_SERVICE=gmail
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
EMAIL_FROM_NAME=打卡系统
```

### 2. 根据邮件服务商配置

#### Gmail（推荐用于测试）

**步骤：**

1. 登录 Gmail 账号
2. 启用两步验证（如果未启用）：
   - 访问：https://myaccount.google.com/security
   - 启用"两步验证"
3. 生成应用专用密码：
   - 访问：https://myaccount.google.com/apppasswords
   - 选择"邮件"和"其他（自定义名称）"
   - 输入名称（如：打卡系统）
   - 点击"生成"
   - 复制生成的16位密码（格式：xxxx xxxx xxxx xxxx，去掉空格）

4. 配置 `.env` 文件：
```env
EMAIL_SERVICE=gmail
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=xxxxxxxxxxxxxxxx  # 使用应用专用密码，不是Gmail密码
EMAIL_FROM_NAME=打卡系统
```

**注意**：
- 必须使用"应用专用密码"，不能使用 Gmail 账户密码
- 应用专用密码是16位字符（去掉空格）

#### QQ邮箱

**步骤：**

1. 登录 QQ 邮箱
2. 开启 SMTP 服务：
   - 访问：https://mail.qq.com/
   - 设置 → 账户
   - 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
   - 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
3. 获取授权码：
   - 点击"生成授权码"
   - 按提示发送短信验证
   - 复制生成的授权码（16位字符）

4. 配置 `.env` 文件：
```env
EMAIL_SERVICE=qq
EMAIL_USER=your-qq@qq.com
EMAIL_PASS=xxxxxxxxxxxxxxxx  # 授权码，不是QQ密码
EMAIL_FROM_NAME=打卡系统
```

#### 163邮箱

**步骤：**

1. 登录 163 邮箱
2. 开启 SMTP 服务：
   - 设置 → POP3/SMTP/IMAP
   - 开启"POP3/SMTP服务"或"IMAP/SMTP服务"
3. 获取授权码：
   - 点击"生成授权码"
   - 按提示发送短信验证
   - 复制生成的授权码

4. 配置 `.env` 文件：
```env
EMAIL_SERVICE=163
EMAIL_USER=your-email@163.com
EMAIL_PASS=xxxxxxxxxxxxxxxx  # 授权码
EMAIL_FROM_NAME=打卡系统
```

#### Outlook/Hotmail

**步骤：**

1. 登录 Outlook 账号
2. 启用两步验证（如果未启用）
3. 生成应用密码：
   - 访问：https://account.microsoft.com/security
   - 高级安全选项 → 应用密码
   - 生成新的应用密码

4. 配置 `.env` 文件：
```env
EMAIL_SERVICE=outlook
EMAIL_USER=your-email@outlook.com
EMAIL_PASS=your-app-password
EMAIL_FROM_NAME=打卡系统
```

#### 自定义 SMTP 服务器

如果使用其他邮件服务商，需要手动配置 SMTP 信息：

```env
EMAIL_SERVICE=custom
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_SECURE=false
EMAIL_USER=your-email@example.com
EMAIL_PASS=your-password
EMAIL_FROM_NAME=打卡系统
```

**常用端口：**
- 587（TLS，推荐）
- 465（SSL）
- 25（不加密，不推荐）

**SMTP_SECURE 设置：**
- 端口 587：`SMTP_SECURE=false`
- 端口 465：`SMTP_SECURE=true`

## 测试邮件配置

### 方法1：通过前端界面测试（推荐）

1. 启动服务器
2. 访问前端：http://localhost:5173
3. 进入"设置"页面
4. 输入紧急联系人邮箱地址
5. 点击"发送测试邮件"按钮
6. 检查邮箱是否收到测试邮件

### 方法2：通过 API 测试

使用 curl 或 Postman 发送请求：

```bash
curl -X POST http://localhost:3000/api/email/test \
  -H "Content-Type: application/json"
```

注意：此方法需要先通过设置 API 配置紧急联系人邮箱。

### 方法3：查看服务器日志

发送测试邮件后，查看服务器控制台输出：

- 成功：显示 "测试邮件发送成功"
- 失败：显示具体错误信息

## 常见问题

### Q1: 提示"认证失败"或"用户名或密码错误"

**原因：**
- 使用了账户密码而不是应用专用密码/授权码
- 应用专用密码/授权码输入错误
- 两步验证未启用（Gmail/Outlook）

**解决方法：**
1. 确认使用的是"应用专用密码"或"授权码"，不是邮箱密码
2. 检查 `.env` 文件中的密码是否正确（注意空格）
3. 重新生成应用专用密码/授权码

### Q2: 提示"连接超时"、"ETIMEOUT"或"无法连接到服务器"

**原因：**
- 网络无法访问 Gmail/Outlook 等国外邮箱服务（在中国大陆常见）
- DNS 解析超时（EDNS 错误）
- SMTP 服务器地址或端口错误
- 网络防火墙阻止
- 邮件服务商阻止了连接

**解决方法：**

1. **如果使用 Gmail/Outlook 遇到连接超时**（推荐使用国内邮箱）：
   - 在中国大陆，Gmail 可能无法直接访问
   - 建议使用 QQ 邮箱或 163 邮箱（见下方配置）

2. **切换到国内邮箱服务商**：
   - **QQ邮箱**：配置简单，稳定可靠（推荐）
   - **163邮箱**：也是不错的选择
   - 配置方法见上方的"QQ邮箱"和"163邮箱"配置步骤

3. **检查网络连接**：
   - 确保网络连接正常
   - 检查防火墙设置
   - 如果在企业网络，可能需要配置代理

4. **检查 SMTP 配置**：
   - 确认 SMTP 服务器地址和端口正确
   - 尝试使用其他端口（587、465、25）

### Q3: Gmail 提示"不允许使用不安全的应用"

**原因：**
Gmail 默认不允许"不够安全的应用"访问。

**解决方法：**
1. 使用"应用专用密码"（推荐，见上方 Gmail 配置步骤）
2. 或访问 https://myaccount.google.com/lesssecureapps 启用"不够安全的应用访问"（不推荐，已废弃）

### Q4: QQ邮箱提示"需要授权"

**原因：**
未开启 SMTP 服务或未获取授权码。

**解决方法：**
1. 登录 QQ 邮箱
2. 开启 SMTP 服务
3. 获取授权码
4. 使用授权码而不是QQ密码

### Q5: 邮件发送成功但收不到

**解决方法：**
1. 检查垃圾邮件文件夹
2. 确认收件人邮箱地址正确
3. 检查邮件服务商的发送限制
4. 查看服务器日志确认是否真的发送成功

### Q6: 开发环境测试

如果只是测试功能，可以使用：
- **Mailtrap**（测试邮件服务，不会真的发送邮件）
- **Ethereal Email**（临时邮箱服务）
- 或者配置一个测试专用的邮件账号

## 配置示例

### 完整的 `.env` 文件示例

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=checkin_app

# 服务器配置
PORT=3000
CORS_ORIGIN=http://localhost:5173

# 邮件服务配置（Gmail 示例）
EMAIL_SERVICE=gmail
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=abcd efgh ijkl mnop  # 应用专用密码，去掉空格
EMAIL_FROM_NAME=打卡系统

# 邮件服务配置（QQ邮箱 示例）
# EMAIL_SERVICE=qq
# EMAIL_USER=123456789@qq.com
# EMAIL_PASS=xxxxxxxxxxxxxxxx  # 授权码
# EMAIL_FROM_NAME=打卡系统
```

## 安全建议

1. **不要提交 `.env` 文件到版本控制**
   - `.env` 文件已添加到 `.gitignore`
   - 包含敏感信息（密码、授权码等）

2. **使用应用专用密码/授权码**
   - 不要使用邮箱账户密码
   - 定期更换授权码

3. **生产环境配置**
   - 使用环境变量而不是配置文件
   - 使用专业的邮件服务（如 SendGrid、Mailgun）
   - 配置 SPF、DKIM 记录提高邮件送达率

## 验证配置

配置完成后，重启服务器：

```bash
npm run dev
```

然后访问设置页面测试邮件发送功能。如果收到测试邮件，说明配置成功！
